import React, { useState, useEffect, useRef, useCallback } from 'react';
import { 
  FileUp, ChevronLeft, ChevronRight, Layout, Type, MousePointer2, AlertCircle,
  Loader2, Settings, X, Sun, Moon, ZoomIn, ZoomOut, Search, Bookmark, Menu, 
  Highlighter, MessageSquare, Plus, Trash2, Copy, Library, CheckCircle2, 
  ArrowLeft, Volume2, Play, Pause, SkipBack, SkipForward, Globe, BookOpen, ExternalLink
} from 'lucide-react';

// PDF.js Libraries
const PDFJS_CDN = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
const PDFJS_WORKER_CDN = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/**
 * INDEXED DB MANAGER
 */
const DB_NAME = 'BH_READER_DB';
const STORE_NAME = 'books';

const dbManager = {
  init: () => new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, 2);
    request.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
    request.onsuccess = (e) => resolve(e.target.result);
    request.onerror = (e) => reject(e.target.error);
  }),
  saveBook: async (book) => {
    const db = await dbManager.init();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).put(book);
    return new Promise((resolve) => tx.oncomplete = resolve);
  },
  getAllBooks: async () => {
    const db = await dbManager.init();
    return new Promise((resolve) => {
      const tx = db.transaction(STORE_NAME, 'readonly');
      tx.objectStore(STORE_NAME).getAll().onsuccess = (e) => resolve(e.target.result);
    });
  },
  deleteBook: async (id) => {
    const db = await dbManager.init();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).delete(id);
  }
};

const App = () => {
  // --- Core State ---
  const [currentView, setCurrentView] = useState('library'); 
  const [library, setLibrary] = useState([]);
  const [currentBook, setCurrentBook] = useState(null);
  const [pdfDoc, setPdfDoc] = useState(null);
  const [numPages, setNumPages] = useState(0);
  const [currentPage, setCurrentPage] = useState(1);
  const [scale, setScale] = useState(1.0);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [theme, setTheme] = useState('light');

  // --- Premium: 3D Flip State ---
  const [isTurning, setIsTurning] = useState(false);
  const [turnDirection, setTurnDirection] = useState('next'); // 'next' | 'prev'

  // --- Premium: TTS State ---
  const [ttsState, setTtsState] = useState({
    playing: false,
    rate: 1.0,
    sentences: [],
    index: 0
  });
  const ttsRef = useRef(null);

  // --- Premium: Look-up State ---
  const [selection, setSelection] = useState(null);
  const [dictResult, setDictResult] = useState(null);
  const [isDictLoading, setIsDictLoading] = useState(false);

  const fileInputRef = useRef(null);

  // Init PDF.js
  useEffect(() => {
    const script = document.createElement('script');
    script.src = PDFJS_CDN;
    script.async = true;
    script.onload = () => {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = PDFJS_WORKER_CDN;
      loadLibrary();
    };
    document.body.appendChild(script);
  }, []);

  const loadLibrary = async () => {
    const books = await dbManager.getAllBooks();
    setLibrary(books);
  };

  // --- TTS Logic ---
  const extractTextForTTS = async (pageNum) => {
    if (!pdfDoc) return;
    const page = await pdfDoc.getPage(pageNum);
    const textContent = await page.getTextContent();
    const text = textContent.items.map(item => item.str).join(' ');
    // 문장 단위 분리 (단순 정규식)
    const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
    setTtsState(prev => ({ ...prev, sentences, index: 0 }));
  };

  const handleTTSPlay = () => {
    if (ttsState.sentences.length === 0) return;
    
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(ttsState.sentences[ttsState.index]);
    utterance.lang = 'ko-KR';
    utterance.rate = ttsState.rate;
    
    utterance.onend = () => {
      if (ttsState.index < ttsState.sentences.length - 1) {
        setTtsState(prev => ({ ...prev, index: prev.index + 1 }));
      } else {
        setTtsState(prev => ({ ...prev, playing: false }));
      }
    };

    window.speechSynthesis.speak(utterance);
    setTtsState(prev => ({ ...prev, playing: true }));
  };

  useEffect(() => {
    if (ttsState.playing) handleTTSPlay();
  }, [ttsState.index]);

  const toggleTTS = () => {
    if (ttsState.playing) {
      window.speechSynthesis.cancel();
      setTtsState(prev => ({ ...prev, playing: false }));
    } else {
      handleTTSPlay();
    }
  };

  // --- 3D Page Flip Logic ---
  const jumpToPage = (num, direction = 'next') => {
    if (num < 1 || num > numPages || isTurning) return;
    
    setTurnDirection(direction);
    setIsTurning(true);
    
    // 애니메이션 시간과 동기화
    setTimeout(() => {
      setCurrentPage(num);
      setIsTurning(false);
      extractTextForTTS(num); // 페이지 넘길 때 TTS 문장 갱신
    }, 600);
  };

  // --- Smart Look-up ---
  const handleLookUp = async () => {
    if (!selection) return;
    setIsDictLoading(true);
    try {
      // 공개된 무료 사전 API 사용 (예: Free Dictionary API)
      const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${selection.text}`);
      const data = await res.json();
      if (Array.isArray(data)) {
        setDictResult({
          word: data[0].word,
          mean: data[0].meanings[0].definitions[0].definition
        });
      } else {
        setDictResult({ word: selection.text, mean: "정의를 찾을 수 없습니다. 외부 검색을 이용해 보세요." });
      }
    } catch {
      setDictResult({ word: selection.text, mean: "사전 기능을 일시적으로 사용할 수 없습니다." });
    } finally {
      setIsDictLoading(false);
    }
  };

  // --- File Handlers ---
  const handleUpload = async (event) => {
    const file = event.target.files[0];
    if (!file || file.type !== 'application/pdf') return;
    setLoading(true);
    try {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      const metadata = await pdf.getMetadata();
      const title = metadata.info.Title || file.name.replace('.pdf', '');
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale: 0.3 });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width; canvas.height = viewport.height;
      await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
      
      const newBook = {
        id: crypto.randomUUID(),
        title,
        cover: canvas.toDataURL('image/jpeg', 0.8),
        blob: file,
        totalPage: pdf.numPages,
        currentPage: 1,
        lastRead: new Date().toISOString(),
      };
      await dbManager.saveBook(newBook);
      loadLibrary();
    } catch (err) { setError("파일을 불러오는데 실패했습니다."); }
    finally { setLoading(false); }
  };

  const openBook = async (book) => {
    setLoading(true);
    setCurrentBook(book);
    try {
      const arrayBuffer = await book.blob.arrayBuffer();
      const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      setPdfDoc(pdf);
      setNumPages(pdf.numPages);
      setCurrentPage(book.currentPage || 1);
      setCurrentView('viewer');
      extractTextForTTS(book.currentPage || 1);
    } catch (err) { setError("도서를 열 수 없습니다."); }
    finally { setLoading(false); }
  };

  // --- Sub-Components ---
  const PdfPage = ({ pageNum, isStatic = false }) => {
    const canvasRef = useRef(null);
    useEffect(() => {
      if (!pdfDoc || !canvasRef.current) return;
      const render = async () => {
        const page = await pdfDoc.getPage(pageNum);
        const dpr = window.devicePixelRatio || 1;
        const vp = page.getViewport({ scale: scale * dpr });
        const canvas = canvasRef.current;
        canvas.height = vp.height; canvas.width = vp.width;
        canvas.style.height = `${vp.height / dpr}px`; canvas.style.width = `${vp.width / dpr}px`;
        await page.render({ canvasContext: canvas.getContext('2d'), viewport: vp }).promise;
      };
      render();
    }, [pdfDoc, pageNum, scale]);

    const handleMouseUp = () => {
      const sel = window.getSelection();
      const text = sel.toString().trim();
      if (text) {
        const rect = sel.getRangeAt(0).getBoundingClientRect();
        setSelection({ text, x: rect.left + rect.width / 2, y: rect.top - 10 });
      } else {
        setSelection(null);
        setDictResult(null);
      }
    };

    return (
      <div 
        className="relative bg-white shadow-2xl transition-transform duration-300"
        onMouseUp={handleMouseUp}
      >
        <canvas ref={canvasRef} className="block w-full h-auto" />
        {/* TTS 하이라이트 레이어 (현재 읽는 문장 시각화) */}
        {!isStatic && ttsState.playing && (
          <div className="absolute inset-0 bg-[#800020]/5 pointer-events-none mix-blend-multiply transition-all" />
        )}
      </div>
    );
  };

  return (
    <div className={`flex flex-col h-screen overflow-hidden transition-colors duration-500 bg-white font-sans text-[#1A1A1A]`}>
      <input type="file" ref={fileInputRef} onChange={handleUpload} accept=".pdf" className="hidden" />

      {/* --- HEADER --- */}
      <header className="h-20 flex-shrink-0 border-b px-10 flex items-center justify-between z-50 bg-white shadow-sm border-slate-100">
        <div className="flex items-center space-x-8">
          {currentView === 'viewer' ? (
            <button onClick={() => { setCurrentView('library'); window.speechSynthesis.cancel(); }} className="flex items-center gap-3 text-sm font-bold text-slate-500 hover:text-[#800020] transition-colors group">
              <ArrowLeft size={20} className="group-hover:-translate-x-1 transition-transform" /> 서재
            </button>
          ) : (
            <div className="flex items-center space-x-3">
              <div className="w-11 h-11 bg-[#800020] rounded-2xl flex items-center justify-center text-white shadow-lg shadow-[#800020]/20">
                <BookOpen size={24} strokeWidth={2.5} />
              </div>
              <h1 className="logo-text text-2xl font-black tracking-tight text-[#800020] uppercase">BH READER</h1>
            </div>
          )}
        </div>

        <div className="flex items-center space-x-6">
          {currentView === 'viewer' && (
             <div className="flex items-center bg-slate-50 border border-slate-100 p-1.5 rounded-2xl">
                <button onClick={toggleTTS} className={`p-2 rounded-xl transition-all ${ttsState.playing ? 'bg-[#800020] text-white' : 'text-[#800020] hover:bg-[#800020]/10'}`}>
                  {ttsState.playing ? <Pause size={20} /> : <Play size={20} />}
                </button>
                <div className="h-6 w-px bg-slate-200 mx-2" />
                <select 
                  value={ttsState.rate} 
                  onChange={(e) => setTtsState(p => ({ ...p, rate: parseFloat(e.target.value) }))}
                  className="bg-transparent text-[10px] font-black uppercase text-[#800020] outline-none px-1"
                >
                  <option value="0.8">0.8x</option>
                  <option value="1.0">1.0x</option>
                  <option value="1.2">1.2x</option>
                  <option value="1.5">1.5x</option>
                </select>
             </div>
          )}
          {currentView === 'library' && (
            <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-2 bg-[#800020] text-white px-8 py-3 rounded-full text-sm font-bold hover:bg-[#600018] shadow-lg shadow-[#800020]/20 active:scale-95 transition-all">
              <Plus size={18} /> 도서 추가
            </button>
          )}
          <button onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')} className="p-3 rounded-full hover:bg-slate-50 transition-colors text-slate-400 hover:text-[#800020]">
            {theme === 'light' ? <Moon size={24} /> : <Sun size={24} />}
          </button>
        </div>
      </header>

      <main className="flex-1 overflow-hidden relative">
        {loading && (
          <div className="absolute inset-0 bg-white/95 backdrop-blur-md z-[60] flex items-center justify-center flex-col gap-6">
            <Loader2 size={54} className="text-[#800020] animate-spin" />
            <p className="text-sm font-black text-[#800020] tracking-[0.2em] uppercase">Processing Library...</p>
          </div>
        )}

        {/* --- LIBRARY VIEW --- */}
        {currentView === 'library' && (
          <div className="h-full overflow-y-auto p-12 custom-scrollbar bg-white">
            <div className="max-w-7xl mx-auto">
              <div className="mb-14">
                <h2 className="text-4xl font-black tracking-tighter mb-4 text-[#1A1A1A]">나의 디지털 서재</h2>
                <div className="h-1.5 w-24 bg-[#800020] rounded-full mb-4" />
                <p className="text-sm text-slate-400 font-bold tracking-wide uppercase">프리미엄 리딩 경험, BH READER와 함께하세요.</p>
              </div>

              {library.length === 0 ? (
                <div className="flex flex-col items-center justify-center py-48 opacity-[0.03]">
                  <Library size={160} className="mb-8" />
                  <p className="text-3xl font-black italic text-center uppercase tracking-tighter">Your library is empty.</p>
                </div>
              ) : (
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-10">
                  {library.map(book => (
                    <div 
                      key={book.id} onClick={() => openBook(book)}
                      className="group relative bg-white rounded-3xl border border-slate-200 p-4 shadow-sm hover:shadow-2xl transition-all cursor-pointer"
                    >
                      <div className="relative aspect-[3/4] rounded-2xl overflow-hidden mb-4 bg-slate-50 shadow-inner">
                        <img src={book.cover} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" />
                      </div>
                      <h3 className="text-base font-bold truncate text-[#1A1A1A] group-hover:text-[#800020] transition-colors">{book.title}</h3>
                      <button onClick={(e) => { e.stopPropagation(); dbManager.deleteBook(book.id); loadLibrary(); }} className="absolute top-6 right-6 p-2 bg-white/95 text-red-500 rounded-2xl opacity-0 group-hover:opacity-100 transition-all shadow-md"><Trash2 size={16} /></button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* --- VIEWER VIEW --- */}
        {currentView === 'viewer' && (
          <div className="h-full flex flex-col bg-slate-50 overflow-hidden relative perspective-1000">
            <div className="flex-1 overflow-hidden flex items-center justify-center relative p-12">
               
               {/* 3D Page Flip Container */}
               <div className={`relative w-full max-w-2xl transition-all duration-600 ${isTurning ? 'turning-container' : ''}`}>
                 <div className={`page-wrapper ${isTurning ? (turnDirection === 'next' ? 'page-flip-next' : 'page-flip-prev') : ''}`}>
                    <PdfPage pageNum={currentPage} />
                 </div>
               </div>

               {/* Smart Selection Popup */}
               {selection && (
                  <div 
                    className="fixed z-[200] bg-slate-900 text-white rounded-2xl shadow-2xl p-2 flex flex-col gap-2 min-w-[200px] animate-in fade-in zoom-in-95 duration-200"
                    style={{ left: selection.x - 100, top: selection.y - 60 }}
                  >
                    {!dictResult ? (
                      <div className="flex items-center justify-around px-2 py-1">
                        <button onClick={handleLookUp} className="flex flex-col items-center gap-1 hover:text-[#800020] transition-colors">
                          <Search size={18} /> <span className="text-[10px] font-bold">사전</span>
                        </button>
                        <button onClick={() => window.open(`https://www.google.com/search?q=${selection.text}`)} className="flex flex-col items-center gap-1 hover:text-blue-400 transition-colors">
                          <Globe size={18} /> <span className="text-[10px] font-bold">웹 검색</span>
                        </button>
                        <button onClick={() => { navigator.clipboard.writeText(selection.text); setSelection(null); }} className="flex flex-col items-center gap-1 hover:text-green-400 transition-colors">
                          <Copy size={18} /> <span className="text-[10px] font-bold">복사</span>
                        </button>
                      </div>
                    ) : (
                      <div className="p-3">
                        <div className="flex justify-between items-center mb-2">
                          <span className="text-sm font-black text-[#800020] uppercase tracking-widest">{dictResult.word}</span>
                          <button onClick={() => setDictResult(null)}><X size={14} /></button>
                        </div>
                        <p className="text-xs text-slate-300 leading-relaxed italic line-clamp-3">{dictResult.mean}</p>
                        <a href={`https://ko.wikipedia.org/wiki/${selection.text}`} target="_blank" className="mt-3 flex items-center gap-1 text-[9px] font-bold text-blue-400 hover:underline">
                          위키백과에서 자세히 보기 <ExternalLink size={10} />
                        </a>
                      </div>
                    )}
                  </div>
               )}
            </div>

            {/* Navigation Buttons */}
            <button onClick={() => jumpToPage(currentPage - 1, 'prev')} disabled={currentPage === 1 || isTurning} className="absolute left-12 top-1/2 -translate-y-1/2 w-16 h-16 bg-white shadow-2xl text-slate-300 hover:text-[#800020] rounded-full flex items-center justify-center transition-all z-40 disabled:opacity-0 active:scale-90">
              <ChevronLeft size={36} strokeWidth={2.5} />
            </button>
            <button onClick={() => jumpToPage(currentPage + 1, 'next')} disabled={currentPage === numPages || isTurning} className="absolute right-12 top-1/2 -translate-y-1/2 w-16 h-16 bg-white shadow-2xl text-slate-300 hover:text-[#800020] rounded-full flex items-center justify-center transition-all z-40 disabled:opacity-0 active:scale-90">
              <ChevronRight size={36} strokeWidth={2.5} />
            </button>
            
            {/* Branded Footer */}
            <footer className="h-14 border-t px-10 flex items-center justify-between bg-white border-slate-100 shadow-up">
              <div className="text-[11px] font-black text-[#800020] uppercase tracking-[0.1em] truncate max-w-[400px]">
                BH READER <span className="mx-2 text-slate-200">/</span> <span className="text-slate-400 font-medium">Page {currentPage} of {numPages}</span>
              </div>
              
              {/* TTS 문장 진행 바 */}
              {ttsState.playing && (
                <div className="flex-1 max-w-md mx-8 flex items-center gap-4">
                  <div className="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                    <div className="h-full bg-[#800020] transition-all duration-300" style={{ width: `${(ttsState.index / ttsState.sentences.length) * 100}%` }} />
                  </div>
                  <span className="text-[10px] font-black text-[#800020]">{ttsState.index + 1}/{ttsState.sentences.length}</span>
                </div>
              )}

              <div className="text-[10px] font-black text-slate-300 uppercase tracking-widest">Premium Interactive Reader</div>
            </footer>
          </div>
        )}
      </main>

      <style dangerouslySetInnerHTML={{ __html: `
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard Variable', sans-serif; background: white; -webkit-font-smoothing: antialiased; }
        .logo-text { font-weight: 900; letter-spacing: -0.05em; }
        .perspective-1000 { perspective: 2000px; }
        
        /* 3D Page Flip Animation */
        .page-wrapper { transform-origin: left center; transition: transform 0.6s cubic-bezier(0.645, 0.045, 0.355, 1); position: relative; }
        .page-flip-next { transform: rotateY(-10deg) translateX(-20px); opacity: 0.7; }
        .page-flip-prev { transform: rotateY(10deg) translateX(20px); opacity: 0.7; }

        /* Burgundy Point Design */
        .page-wrapper::after {
          content: ""; position: absolute; inset: 0; 
          background: linear-gradient(to right, rgba(128, 0, 32, 0.05), transparent);
          pointer-events: none; opacity: 0; transition: opacity 0.6s;
        }
        .is-turning .page-wrapper::after { opacity: 1; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #800020; border-radius: 10px; }
        .shadow-up { box-shadow: 0 -10px 30px -5px rgba(0, 0, 0, 0.04); }
        
        ::selection { background: rgba(128, 0, 32, 0.2); color: inherit; }
      `}} />
    </div>
  );
};

export default App;
